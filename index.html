<!DOCTYPE HTML>
<html>
	<head>	
		<meta charset="utf-8" />
		<title>Simple HTML</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script src="https://unpkg.com/tone"></script>
	</head>
	<body>

        <div>
            <label for="video-file">Scegli un file video:</label>
            <input type="file" id="video-file" accept="video/*">
        </div>

        <video id="music" width="640" height="360" controls muted style="display: none;">
            Il tuo browser non supporta l'elemento video.
        </video>

        <div id="controls" style="display: none;">
            <input type="range" id="pitch" min="-12" max="12" value="0" step="1" oninput="updatePitchOutput(this.value)">
            <input type="text" id="pitch-input" value="0" oninput="updatePitchOutput(this.value)">
            <output id="pitch-output">0</output>

            <input type="range" id="playback-rate" min="10" max="300" value="100" step="1" oninput="updatePlaybackRateOutput(this.value)">
            <input type="text" id="playback-rate-input" value="100" oninput="updatePlaybackRateOutput(this.value)">
            <output id="playback-rate-output">100</output>

            <input type="range" id="volume" min=0 max=100 value=100 step=1 oninput="updateVolumeOutput(this.value)">
            <input type="text" id="volume-input" value="0" oninput="updateVolumeOutput(this.value)">
            <output id="volume-output">100</output>

            <div>
                <label>Loop</label>
                <div>
                    <div id="start-input-wrapper">
                        <label>Inizio</label>
                        <input type="text" id="start-time-input" placeholder="es. 30 o 1:30">
                        <div id="start-error" style="display: none; color: red;">Tempo non valido</div>
                    </div>
                    <div id="stop-input-wrapper">
                        <label>Fine</label>
                        <input type="text" id="stop-time-input" placeholder="es. 90 o 2:30">
                        <div id="stop-error" style="display: none; color: red;">Deve essere > tempo inizio</div>
                    </div>
                </div>
                <div>
                    <button id="start" data-start-value=''>Dal Corrente</button>
                    <button id="stop" data-stop-value=''>Al Corrente</button>
                </div>
                <div>
                    <span>Inizio: <span id="start-value">--:--</span></span>
                    <span>Fine: <span id="stop-value">--:--</span></span>
                </div>
                <button id="reset">Reset Loop</button>
            </div>
        </div>

		<script>
            const music = document.getElementById("music");
            const videoFileInput = document.getElementById("video-file");
            const controls = document.getElementById("controls");
            
            let player = null;
            let pitch_shift = null;
            let isVideoLoaded = false;
            let isToneInitialized = false;

            // Gestisce la selezione del file video
            videoFileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                    loadVideo(file);
                }
            });

            function loadVideo(file) {
                // Reset dello stato precedente
                if (player) {
                    player.dispose();
                    player = null;
                }
                if (pitch_shift) {
                    pitch_shift.dispose();
                    pitch_shift = null;
                }
                isVideoLoaded = false;
                isToneInitialized = false;
                
                // Nasconde i controlli durante il caricamento
                controls.style.display = 'none';
                music.style.display = 'none';

                // Crea URL per il file selezionato
                const videoUrl = URL.createObjectURL(file);
                music.src = videoUrl;
                
                // Mostra il video
                music.style.display = 'block';
                
                // Aspetta che il video sia caricato prima di inizializzare Tone.js
                music.addEventListener('loadeddata', function() {
                    isVideoLoaded = true;
                    initializeTone(videoUrl);
                }, { once: true });

                music.addEventListener('error', function() {
                    alert('Errore nel caricamento del video. Assicurati che il file sia un video valido.');
                    music.style.display = 'none';
                });
            }

            async function initializeTone(videoUrl) {
                try {
                    // Inizializza Tone.js context se necessario
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                    }

                    // Crea il player Tone.js con il video caricato
                    player = new Tone.Player(videoUrl);
                    pitch_shift = new Tone.PitchShift({}).toDestination();

                    // Aspetta che Tone.js abbia caricato l'audio
                    await Tone.loaded();
                    
                    // Connette il player al pitch shifter
                    player.connect(pitch_shift);
                    
                    isToneInitialized = true;
                    
                    // Mostra i controlli
                    controls.style.display = 'block';
                    
                    // Carica le impostazioni salvate
                    check_session_settings();
                    
                    console.log('Tone.js inizializzato correttamente');
                } catch (error) {
                    console.error('Errore nell\'inizializzazione di Tone.js:', error);
                    alert('Errore nell\'inizializzazione dell\'audio. Riprova.');
                }
            }

            music.addEventListener('play', () => {
                if (isToneInitialized && player) {
                    player.start(0, music.currentTime);
                }
            });

            music.addEventListener('pause', () => {
                if (player) {
                    player.stop();
                }
            });


            function parseTimeInput(input) {
                if (!input) return null;
                
                input = input.trim();
                
                if (/^\d+$/.test(input)) {
                    return parseInt(input);
                }
                
                if (input.includes(':')) {
                    const parts = input.split(':').map(p => parseInt(p) || 0);
                    if (parts.length === 2) {
                        return parts[0] * 60 + parts[1];
                    } else if (parts.length === 3) {
                        return parts[0] * 3600 + parts[1] * 60 + parts[2];
                    }
                }
                
                return null;
            }

            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                
                if (hours > 0) {
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                } else {
                    return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            }

            function validateTimes() {
                const startInput = document.getElementById('start-time-input');
                const stopInput = document.getElementById('stop-time-input');
                const startError = document.getElementById('start-error');
                const stopError = document.getElementById('stop-error');

                const startTime = parseTimeInput(startInput.value);
                const stopTime = parseTimeInput(stopInput.value);

                // Reset errors
                startError.style.display = 'none';
                stopError.style.display = 'none';

                let isValid = true;

                if (startInput.value && startTime === null) {
                    startError.style.display = 'block';
                    isValid = false;
                }

                if (stopInput.value && stopTime === null) {
                    stopError.style.display = 'block';
                    isValid = false;
                }

                if (startTime !== null && stopTime !== null && startTime >= stopTime) {
                    stopError.style.display = 'block';
                    isValid = false;
                }

                return isValid;
            }

            document.getElementById('start-time-input').addEventListener('input', function() {
                validateTimes();
                const time = parseTimeInput(this.value);
                if (time !== null && validateTimes()) {
                    music.currentTime = time;
                    document.getElementById('start').dataset.startValue = time;
                    document.getElementById('start-value').innerHTML = formatTime(time);
                }
            });

            document.getElementById('stop-time-input').addEventListener('input', function() {
                validateTimes();
                const time = parseTimeInput(this.value);
                if (time !== null && validateTimes()) {
                    document.getElementById('stop').dataset.stopValue = time;
                    document.getElementById('stop-value').innerHTML = formatTime(time);
                }
            });

            const startButton = document.getElementById('start');
            const stopButton = document.getElementById('stop');
            const resetButton = document.getElementById('reset');
            
            startButton.addEventListener('click', function() {
                this.dataset.startValue = music.currentTime;
                document.getElementById('start-value').innerHTML = formatTime(this.dataset.startValue);
            });

            stopButton.addEventListener('click', function() {
                this.dataset.stopValue = music.currentTime;
                document.getElementById('stop-value').innerHTML = formatTime(this.dataset.stopValue);
            });

            resetButton.addEventListener('click', function() {
                startButton.dataset.startValue = '';
                stopButton.dataset.stopValue = '';
                document.getElementById('start-value').innerHTML = '--:--';
                document.getElementById('stop-value').innerHTML = '--:--';
                document.getElementById('start-time-input').value = '';
                document.getElementById('stop-time-input').value = '';
                validateTimes();
            });

            function updatePitchOutput(value) {
                if (!isToneInitialized || !pitch_shift) return;
                
                const parsedValue = Number(value);
                if (isNaN(parsedValue)) {
                    return;
                }
                const clampedValue = Math.max(-12, Math.min(parsedValue, 12));

                const pitchRange = document.getElementById('pitch');
                const pitchOutput = document.getElementById('pitch-output');
                const pitchInput = document.getElementById('pitch-input');

                pitchRange.value = clampedValue;
                pitchOutput.textContent = clampedValue;
                pitchInput.value = clampedValue;
                pitch_shift.pitch = clampedValue;

                localStorage.setItem('pitch', clampedValue);
            }

            function updatePlaybackRateOutput(value) {
                const parsedValue = Number(value);
                if (isNaN(parsedValue)) {
                    return;
                }

                const music_element = document.getElementById('music'); 
                music_element.playbackRate = parsedValue / 100;

                const clampedValue = Math.max(10, Math.min(parsedValue, 300));

                const playbackRateRange = document.getElementById('playback-rate');
                const playbackRateOutput = document.getElementById('playback-rate-output');
                const playbackRateInput = document.getElementById('playback-rate-input');

                playbackRateRange.value = clampedValue;
                playbackRateOutput.textContent = clampedValue;
                playbackRateInput.value = clampedValue;
                
                if (isToneInitialized && player) {
                    player.playbackRate = clampedValue / 100;
                }

                localStorage.setItem('playback-rate', clampedValue);
            }

            function updateVolumeOutput(value) {
                if (!isToneInitialized || !player) return;
                
                const parsedValue = Number(value);
                if (isNaN(parsedValue)) {
                    return;
                }
                const clampedValue = Math.max(0, Math.min(parsedValue, 100));

                const volumeRange = document.getElementById('volume');
                const volumeOutput = document.getElementById('volume-output');
                const volumeInput = document.getElementById('volume-input');

                volumeRange.value = clampedValue;
                volumeOutput.textContent = clampedValue;
                volumeInput.value = clampedValue;
                player.volume.value = clampedValue - 100;

                localStorage.setItem('volume', clampedValue - 100);
            }

            function check_session_settings() {
                if (!isToneInitialized || !player || !pitch_shift) return;
                
                const volume_local = localStorage.getItem('volume');

                const volume_output = document.getElementById('volume-output');
                const volume_input = document.getElementById('volume-input');
                const volume = document.getElementById('volume');
                if (volume_local) {
                    player.volume.value = volume_local;
                    volume_output.textContent = 100 + Number(volume_local);
                    volume_input.value = 100 + Number(volume_local);
                    volume.value = 100 + Number(volume_local);
                }

                const pitch = localStorage.getItem('pitch');
                const pitch_output = document.getElementById('pitch-output');
                const pitch_input = document.getElementById('pitch');

                if (pitch) {
                    pitch_shift.pitch = pitch;
                    pitch_output.textContent = pitch;
                    pitch_input.value = pitch;
                }
                
                const playback_rate = localStorage.getItem('playback-rate');
                const playback_rate_output = document.getElementById('playback-rate-output');
                const playback_rate_input = document.getElementById('playback-rate');
                const music_element = document.getElementById('music');

                if (playback_rate) {
                    player.playbackRate = playback_rate / 100;
                    playback_rate_output.textContent = playback_rate;
                    playback_rate_input.value = playback_rate;
                    music_element.playbackRate = playback_rate / 100;
                }
            }

            music.addEventListener('timeupdate', () => {
                const startButton = document.getElementById('start');
                const stopButton = document.getElementById('stop');
                if (startButton.dataset.startValue && stopButton.dataset.stopValue) {
                    if (music.currentTime > stopButton.dataset.stopValue || music.currentTime < startButton.dataset.startValue) {
                        music.currentTime = startButton.dataset.startValue;
                        player.start(0, music.currentTime);
                    }
                }
            });

        </script>
	</body>
</html>
