<!DOCTYPE HTML>
<html>
	<head>	
		<meta charset="utf-8" />
		<title>Simple HTML</title>
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<script src="https://unpkg.com/tone"></script>
	</head>
	<body>

        <video id="music" src="video.mp4" width="640" height="360" controls autoplay muted></video>

        <input type="range" id="pitch" min="-12" max="12" value="0" step="1" oninput="updatePitchOutput(this.value)">
        <input type="text" id="pitch-input" value="0" oninput="updatePitchOutput(this.value)">
        <output id="pitch-output">0</output>

        <input type="range" id="playback-rate" min="10" max="300" value="100" step="1" oninput="updatePlaybackRateOutput(this.value)">
        <input type="text" id="playback-rate-input" value="100" oninput="updatePlaybackRateOutput(this.value)">
        <output id="playback-rate-output">100</output>

        <input type="range" id="volume" min=0 max=100 value=100 step=1 oninput="updateVolumeOutput(this.value)">
        <input type="text" id="volume-input" value="0" oninput="updateVolumeOutput(this.value)">
        <output id="volume-output">100</output>

        <div>
            <label>Loop</label>
            <div>
                <div id="start-input-wrapper">
                    <label>Inizio</label>
                    <input type="text" id="start-time-input" placeholder="es. 30 o 1:30">
                    <div id="start-error" style="display: none; color: red;">Tempo non valido</div>
                </div>
                <div id="stop-input-wrapper">
                    <label>Fine</label>
                    <input type="text" id="stop-time-input" placeholder="es. 90 o 2:30">
                    <div id="stop-error" style="display: none; color: red;">Deve essere > tempo inizio</div>
                </div>
            </div>
            <div>
                <button id="start" data-start-value=''>Dal Corrente</button>
                <button id="stop" data-stop-value=''>Al Corrente</button>
            </div>
            <div>
                <span>Inizio: <span id="start-value">--:--</span></span>
                <span>Fine: <span id="stop-value">--:--</span></span>
            </div>
            <button id="reset">Reset Loop</button>
        </div>

		<script>
            const music = document.getElementById("music");
            music.pause();
            
            const player = new Tone.Player(
                "video.mp4"
            );
            pitch_shift = new Tone.PitchShift({}).toDestination();

            Tone.loaded().then(() => {
                player.connect(pitch_shift);
            });

            check_session_settings();

            music.addEventListener('play', () => {
                Tone.loaded().then(() => {
                    player.start(0, music.currentTime);
                })
            });

            music.addEventListener('pause', () => {
                player.stop();
            });

            music.addEventListener('timeupdate', () => {
                const startButton = document.getElementById('start');
                const stopButton = document.getElementById('stop');
                if (startButton.dataset.startValue && stopButton.dataset.stopValue) {
                    if (music.currentTime > stopButton.dataset.stopValue || music.currentTime < startButton.dataset.startValue) {
                        music.currentTime = startButton.dataset.startValue;
                    }
                }
            });

            function parseTimeInput(input) {
                if (!input) return null;
                
                input = input.trim();
                
                if (/^\d+$/.test(input)) {
                    return parseInt(input);
                }
                
                if (input.includes(':')) {
                    const parts = input.split(':').map(p => parseInt(p) || 0);
                    if (parts.length === 2) {
                        return parts[0] * 60 + parts[1];
                    } else if (parts.length === 3) {
                        return parts[0] * 3600 + parts[1] * 60 + parts[2];
                    }
                }
                
                return null;
            }

            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = Math.floor(seconds % 60);
                
                if (hours > 0) {
                    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                } else {
                    return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                }
            }

            function validateTimes() {
                const startInput = document.getElementById('start-time-input');
                const stopInput = document.getElementById('stop-time-input');
                const startError = document.getElementById('start-error');
                const stopError = document.getElementById('stop-error');

                const startTime = parseTimeInput(startInput.value);
                const stopTime = parseTimeInput(stopInput.value);

                // Reset errors
                startError.style.display = 'none';
                stopError.style.display = 'none';

                let isValid = true;

                if (startInput.value && startTime === null) {
                    startError.style.display = 'block';
                    isValid = false;
                }

                if (stopInput.value && stopTime === null) {
                    stopError.style.display = 'block';
                    isValid = false;
                }

                if (startTime !== null && stopTime !== null && startTime >= stopTime) {
                    stopError.style.display = 'block';
                    isValid = false;
                }

                return isValid;
            }

            document.getElementById('start-time-input').addEventListener('input', function() {
                validateTimes();
                const time = parseTimeInput(this.value);
                if (time !== null && validateTimes()) {
                    music.currentTime = time;
                    document.getElementById('start').dataset.startValue = time;
                    document.getElementById('start-value').innerHTML = formatTime(time);
                }
            });

            document.getElementById('stop-time-input').addEventListener('input', function() {
                validateTimes();
                const time = parseTimeInput(this.value);
                if (time !== null && validateTimes()) {
                    document.getElementById('stop').dataset.stopValue = time;
                    document.getElementById('stop-value').innerHTML = formatTime(time);
                }
            });

            const startButton = document.getElementById('start');
            const stopButton = document.getElementById('stop');
            const resetButton = document.getElementById('reset');
            
            startButton.addEventListener('click', function() {
                this.dataset.startValue = music.currentTime;
                document.getElementById('start-value').innerHTML = formatTime(this.dataset.startValue);
            });

            stopButton.addEventListener('click', function() {
                this.dataset.stopValue = music.currentTime;
                document.getElementById('stop-value').innerHTML = formatTime(this.dataset.stopValue);
            });

            resetButton.addEventListener('click', function() {
                startButton.dataset.startValue = '';
                stopButton.dataset.stopValue = '';
                document.getElementById('start-value').innerHTML = '--:--';
                document.getElementById('stop-value').innerHTML = '--:--';
                document.getElementById('start-time-input').value = '';
                document.getElementById('stop-time-input').value = '';
                validateTimes();
            });

            function updatePitchOutput(value) {
                const parsedValue = Number(value);
                if (isNaN(parsedValue)) {
                    return;
                }
                const clampedValue = Math.max(-12, Math.min(parsedValue, 12));

                const pitchRange = document.getElementById('pitch');
                const pitchOutput = document.getElementById('pitch-output');
                const pitchInput = document.getElementById('pitch-input');

                pitchRange.value = clampedValue;
                pitchOutput.textContent = clampedValue;
                pitchInput.value = clampedValue;
                pitch_shift.pitch = clampedValue;

                localStorage.setItem('pitch', clampedValue);
            }

            function updatePlaybackRateOutput(value) {
                const parsedValue = Number(value);
                if (isNaN(parsedValue)) {
                    return;
                }
                const clampedValue = Math.max(10, Math.min(parsedValue, 300));

                const playbackRateRange = document.getElementById('playback-rate');
                const playbackRateOutput = document.getElementById('playback-rate-output');
                const playbackRateInput = document.getElementById('playback-rate-input');

                playbackRateRange.value = clampedValue;
                playbackRateOutput.textContent = clampedValue;
                playbackRateInput.value = clampedValue;
                player.playbackRate = clampedValue / 100;

                localStorage.setItem('playback-rate', clampedValue);
            }

            function updateVolumeOutput(value) {
                const parsedValue = Number(value);
                if (isNaN(parsedValue)) {
                    return;
                }
                const clampedValue = Math.max(0, Math.min(parsedValue, 100));

                const volumeRange = document.getElementById('volume');
                const volumeOutput = document.getElementById('volume-output');
                const volumeInput = document.getElementById('volume-input');

                volumeRange.value = clampedValue;
                volumeOutput.textContent = clampedValue;
                volumeInput.value = clampedValue;
                player.volume.value = clampedValue - 100;

                localStorage.setItem('volume', clampedValue - 100);
            }

            function check_session_settings() {
                const volume_local = localStorage.getItem('volume');

                const volume_output = document.getElementById('volume-output');
                const volume_input = document.getElementById('volume-input');
                const volume = document.getElementById('volume');
                if (volume_local) {
                    player.volume.value = volume_local;
                    volume_output.textContent = 100 + Number(volume_local);
                    volume_input.value = 100 + Number(volume_local);
                    volume.value = 100 + Number(volume_local);
                }

                const pitch = localStorage.getItem('pitch');
                const pitch_output = document.getElementById('pitch-output');
                const pitch_input = document.getElementById('pitch');

                if (pitch) {
                    pitch_shift.pitch = pitch;
                    pitch_output.textContent = pitch;
                    pitch_input.value = pitch;
                }
                
                const playback_rate = localStorage.getItem('playback-rate');
                const playback_rate_output = document.getElementById('playback-rate-output');
                const playback_rate_input = document.getElementById('playback-rate');

                if (playback_rate) {
                    player.playbackRate = playback_rate / 100;
                    playback_rate_output.textContent = playback_rate;
                    playback_rate_input.value = playback_rate;
                }
            }
        </script>
	</body>
</html>
